import sys
import os.path
from PIL import Image

# Translate rows into screen memory offsets
lineOffset = [    
    0x0000, 0x0000+0x0400, 0x0000+0x0800, 0x0000+0x0c00, 0x0000+0x1000, 0x0000+0x1400, 0x0000+0x1800, 0x0000+0x1c00,
    0x0080, 0x0080+0x0400, 0x0080+0x0800, 0x0080+0x0c00, 0x0080+0x1000, 0x0080+0x1400, 0x0080+0x1800, 0x0080+0x1c00,
    0x0100, 0x0100+0x0400, 0x0100+0x0800, 0x0100+0x0c00, 0x0100+0x1000, 0x0100+0x1400, 0x0100+0x1800, 0x0100+0x1c00,
    0x0180, 0x0180+0x0400, 0x0180+0x0800, 0x0180+0x0c00, 0x0180+0x1000, 0x0180+0x1400, 0x0180+0x1800, 0x0180+0x1c00,
    0x0200, 0x0200+0x0400, 0x0200+0x0800, 0x0200+0x0c00, 0x0200+0x1000, 0x0200+0x1400, 0x0200+0x1800, 0x0200+0x1c00,
    0x0280, 0x0280+0x0400, 0x0280+0x0800, 0x0280+0x0c00, 0x0280+0x1000, 0x0280+0x1400, 0x0280+0x1800, 0x0280+0x1c00,
    0x0300, 0x0300+0x0400, 0x0300+0x0800, 0x0300+0x0c00, 0x0300+0x1000, 0x0300+0x1400, 0x0300+0x1800, 0x0300+0x1c00,
    0x0380, 0x0380+0x0400, 0x0380+0x0800, 0x0380+0x0c00, 0x0380+0x1000, 0x0380+0x1400, 0x0380+0x1800, 0x0380+0x1c00,
    0x0028, 0x0028+0x0400, 0x0028+0x0800, 0x0028+0x0c00, 0x0028+0x1000, 0x0028+0x1400, 0x0028+0x1800, 0x0028+0x1c00,
    0x00A8, 0x00A8+0x0400, 0x00A8+0x0800, 0x00A8+0x0c00, 0x00A8+0x1000, 0x00A8+0x1400, 0x00A8+0x1800, 0x00A8+0x1c00,
    0x0128, 0x0128+0x0400, 0x0128+0x0800, 0x0128+0x0c00, 0x0128+0x1000, 0x0128+0x1400, 0x0128+0x1800, 0x0128+0x1c00,
    0x01A8, 0x01A8+0x0400, 0x01A8+0x0800, 0x01A8+0x0c00, 0x01A8+0x1000, 0x01A8+0x1400, 0x01A8+0x1800, 0x01A8+0x1c00,
    0x0228, 0x0228+0x0400, 0x0228+0x0800, 0x0228+0x0c00, 0x0228+0x1000, 0x0228+0x1400, 0x0228+0x1800, 0x0228+0x1c00,
    0x02A8, 0x02A8+0x0400, 0x02A8+0x0800, 0x02A8+0x0c00, 0x02A8+0x1000, 0x02A8+0x1400, 0x02A8+0x1800, 0x02A8+0x1c00,
    0x0328, 0x0328+0x0400, 0x0328+0x0800, 0x0328+0x0c00, 0x0328+0x1000, 0x0328+0x1400, 0x0328+0x1800, 0x0328+0x1c00,
    0x03A8, 0x03A8+0x0400, 0x03A8+0x0800, 0x03A8+0x0c00, 0x03A8+0x1000, 0x03A8+0x1400, 0x03A8+0x1800, 0x03A8+0x1c00,
    0x0050, 0x0050+0x0400, 0x0050+0x0800, 0x0050+0x0c00, 0x0050+0x1000, 0x0050+0x1400, 0x0050+0x1800, 0x0050+0x1c00,
    0x00D0, 0x00D0+0x0400, 0x00D0+0x0800, 0x00D0+0x0c00, 0x00D0+0x1000, 0x00D0+0x1400, 0x00D0+0x1800, 0x00D0+0x1c00,
    0x0150, 0x0150+0x0400, 0x0150+0x0800, 0x0150+0x0c00, 0x0150+0x1000, 0x0150+0x1400, 0x0150+0x1800, 0x0150+0x1c00,
    0x01D0, 0x01D0+0x0400, 0x01D0+0x0800, 0x01D0+0x0c00, 0x01D0+0x1000, 0x01D0+0x1400, 0x01D0+0x1800, 0x01D0+0x1c00,
    0x0250, 0x0250+0x0400, 0x0250+0x0800, 0x0250+0x0c00, 0x0250+0x1000, 0x0250+0x1400, 0x0250+0x1800, 0x0250+0x1c00,
    0x02D0, 0x02D0+0x0400, 0x02D0+0x0800, 0x02D0+0x0c00, 0x02D0+0x1000, 0x02D0+0x1400, 0x02D0+0x1800, 0x02D0+0x1c00,
    0x0350, 0x0350+0x0400, 0x0350+0x0800, 0x0350+0x0c00, 0x0350+0x1000, 0x0350+0x1400, 0x0350+0x1800, 0x0350+0x1c00,
    0x03D0, 0x03D0+0x0400, 0x03D0+0x0800, 0x03D0+0x0c00, 0x03D0+0x1000, 0x03D0+0x1400, 0x03D0+0x1800, 0x03D0+0x1c00];

def writeScreen(srcWidth,srcHeight,remap,data,output):
    width = int(srcWidth*2/7)
    height = srcHeight
    if (remap):
        print("; Remapping image to screen")
        outputBytes = bytearray(8192)
        for y in range(height):
            for x in range(width):
                outputBytes[lineOffset[y]+x] = data[y][x]
    else:
        print("; Linear output")
        outputBytes = bytearray(width*height)
        for y in range(height):
            for x in range(width):
                outputBytes[y*width+x] = data[y][x]
    with open(output, "wb") as binary_file:
        byteCount = binary_file.write(outputBytes)

paletteNames    = [ "black",        "purple",       "green",        "blue",         "orange",       "white"        ]
paletteColors   = [ (  0,  0,   0 ),(217, 60,  240),( 38, 195,  15),( 38, 151, 240),(217, 104,  15),(255, 255, 255)]
paletteBits     = [ 0,              1,              2,              1,              2,              3]
paletteMSB      = [ 0,              0,              0,              1,              1,              0]

def closestMatch(colors):
    minScore = 9999999
    minIndex = 0
    for paletteIndex in range(len(paletteColors)):
        testScore = 0
        for colorBand in range(len(paletteColors[0])):
            testScore = testScore + abs(colors[colorBand] - paletteColors[paletteIndex][colorBand]) ** 2
        if testScore < minScore:
            minIndex = paletteIndex
            minScore = testScore
    return(minIndex)

# Usage: inputFile outputFile width height remapToScreen
# FIXME: use a real command line parser

def main():

    infile = sys.argv[1]
    outfile = sys.argv[2]
    width = int(sys.argv[3])
    height = int(sys.argv[4])
    remap = int(sys.argv[5])

    source = Image.open(infile)
    print(";",infile,source.format, source.size, source.mode)
    im = source.resize((width,height)).convert("RGB")

    im.save(outfile)
    print(";",outfile,im.format, im.size, im.mode)

    allData = []
    evenData = []
    oddData = []
    for y in range(im.size[1]):
        value = 0
        msb = 0
        line = []
        for x in range(im.size[0]):
            s = x*2
            color = closestMatch(im.getpixel((x,y)))
            # print(x,y,color,paletteNames[color],paletteBits[color],paletteMSB[color],paletteMSB[color] << 7)
            # write out 2 bits for each pixel into a 7-bit bytes
            value = value | (paletteBits[color] << s%7)
            msb = msb | (paletteMSB[color] << 7)
            if (s%7 == 6):
                dataByte = (value & 0x7f) | msb
                line.append(dataByte)
                value = (value & 0x80) >> 7
                #print(f"${dataByte:02X}")
            elif (s%7 == 5):
                dataByte = (value & 0x7f) | msb
                line.append(dataByte)
                #print(f"${dataByte:02X}")
                value = 0
                msb = 0

        allData.append(line)
        evenData.append(line[0::2])
        oddData.append(line[1::2])
    writeScreen(width, height, remap, allData, os.path.splitext(outfile)[0] + ".bin")

main()